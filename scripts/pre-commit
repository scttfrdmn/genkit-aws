#!/bin/bash
# Pre-commit hook for GenKit AWS project
# Ensures code quality before commits

set -e

echo "Running pre-commit checks..."

# Check formatting
echo "1. Checking code formatting..."
if [ -n "$(gofmt -l .)" ]; then
    echo "‚ùå Code is not formatted. Run: go fmt ./..."
    gofmt -l .
    exit 1
fi
echo "‚úÖ Code formatting: OK"

# Run go vet
echo "2. Running go vet..."
if ! go vet ./...; then
    echo "‚ùå go vet failed"
    exit 1
fi
echo "‚úÖ go vet: OK"

# Check for inefficient assignments
echo "3. Checking for inefficient assignments..."
if ! $HOME/go/bin/ineffassign ./...; then
    echo "‚ùå ineffassign check failed"
    exit 1
fi
echo "‚úÖ ineffassign: OK"

# Check cyclomatic complexity
echo "4. Checking cyclomatic complexity..."
if [ -n "$($HOME/go/bin/gocyclo -over 15 .)" ]; then
    echo "‚ùå Functions with high complexity found:"
    $HOME/go/bin/gocyclo -over 15 .
    exit 1
fi
echo "‚úÖ gocyclo: OK"

# Check for spelling errors
echo "5. Checking for spelling errors..."
if [ -n "$($HOME/go/bin/misspell .)" ]; then
    echo "‚ùå Spelling errors found:"
    $HOME/go/bin/misspell .
    exit 1
fi
echo "‚úÖ misspell: OK"

# Run staticcheck
echo "6. Running staticcheck..."
if ! staticcheck ./...; then
    echo "‚ùå staticcheck failed"
    exit 1
fi
echo "‚úÖ staticcheck: OK"

# Run tests
echo "7. Running tests..."
if ! go test -race ./...; then
    echo "‚ùå Tests failed"
    exit 1
fi
echo "‚úÖ Tests: OK"

# Build everything
echo "8. Building project..."
if ! go build ./...; then
    echo "‚ùå Build failed"
    exit 1
fi
echo "‚úÖ Build: OK"

echo ""
echo "üéâ All pre-commit checks passed!"
echo "‚úÖ Code is ready for commit"